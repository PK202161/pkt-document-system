import React, { useState, useEffect } from 'react';
import {
  Upload,
  Card,
  Button,
  Select,
  Progress,
  Alert,
  Typography,
  Space,
  Row,
  Col,
  message,
  List,
  Tag,
  Divider,
  Steps,
  Result,
  Modal,
  Table
} from 'antd';
import {
  InboxOutlined,
  UploadOutlined,
  FileTextOutlined,
  CheckCircleOutlined,
  ExclamationCircleOutlined,
  DeleteOutlined,
  EyeOutlined,
  ArrowRightOutlined,
  ClockCircleOutlined,
  WarningOutlined,
  BulbOutlined,
  SyncOutlined
} from '@ant-design/icons';
import type { UploadProps, UploadFile } from 'antd';
import axios from 'axios';

const { Dragger } = Upload;
const { Title, Text } = Typography;
const { Step } = Steps;

interface UploadResponse {
  success: boolean;
  message: string;
  document?: {
    id: number;
    docNumber: string;
    docType: string;
    fileName: string;
  };
}

interface ProcessedFile {
  file: UploadFile;
  status: 'waiting' | 'uploading' | 'success' | 'error';
  result?: UploadResponse;
  progress: number;
  detectedType?: string;
  detectedNumber?: string;
  typeMatch: boolean;
}

interface FileTypeInfo {
  fileName: string;
  detectedType: string | null;
  detectedNumber: string | null;
  confidence: 'high' | 'medium' | 'low';
  reason: string;
}

interface DocumentUploadProps {
  onUploadSuccess?: () => void; // Callback ‡πÄ‡∏°‡∏∑‡πà‡∏≠ upload ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
}

const DocumentUpload: React.FC<DocumentUploadProps> = ({ onUploadSuccess }) => {
  const [fileList, setFileList] = useState<UploadFile[]>([]);
  const [processedFiles, setProcessedFiles] = useState<ProcessedFile[]>([]);
  const [currentUploadIndex, setCurrentUploadIndex] = useState<number>(-1);
  const [isProcessing, setIsProcessing] = useState(false);
  const [fileTypeAnalysis, setFileTypeAnalysis] = useState<FileTypeInfo[]>([]);

  // Auto-detect document type from filename
  const detectDocumentType = (fileName: string): { 
    type: string | null; 
    number: string | null;
    confidence: 'high' | 'medium' | 'low'; 
    reason: string;
  } => {
    const name = fileName.toUpperCase();
    
    // High confidence patterns - ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å (Primary Documents)
    const primaryPatterns = [
      { regex: /^(SO\d{7})/, type: 'SO', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ SO + ‡πÄ‡∏•‡∏Ç 7 ‡∏´‡∏•‡∏±‡∏Å' },
      { regex: /^(EN\d{7})/, type: 'EN', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ EN + ‡πÄ‡∏•‡∏Ç 7 ‡∏´‡∏•‡∏±‡∏Å' },
      { regex: /^(SH\d{7})/, type: 'SH', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ SH + ‡πÄ‡∏•‡∏Ç 7 ‡∏´‡∏•‡∏±‡∏Å' }
    ];

    for (const pattern of primaryPatterns) {
      const match = name.match(pattern.regex);
      if (match) {
        return { 
          type: pattern.type, 
          number: match[1],
          confidence: 'high', 
          reason: pattern.reason
        };
      }
    }

    // Medium confidence patterns - ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
    const legacyPatterns = [
      { regex: /(SO_|_SO_)/, type: 'SO', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ SO_ (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)' },
      { regex: /(EN_|_EN_)/, type: 'EN', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ EN_ (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)' },
      { regex: /(SH_|_SH_)/, type: 'SH', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ SH_ (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)' }
    ];

    for (const pattern of legacyPatterns) {
      if (name.match(pattern.regex)) {
        return { 
          type: pattern.type, 
          number: null,
          confidence: 'medium', 
          reason: pattern.reason
        };
      }
    }

    // Low confidence patterns - ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    const keywordPatterns = [
      { keywords: ['‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢', 'ORDER'], type: 'SO', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ORDER' },
      { keywords: ['‡πÄ‡∏ö‡∏¥‡∏Å', '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', 'PROJECT'], type: 'EN', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡πÄ‡∏ö‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' },
      { keywords: ['‡∏™‡∏≤‡∏Ç‡∏≤', 'BRANCH', 'SHIP'], type: 'SH', reason: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ BRANCH' }
    ];

    for (const pattern of keywordPatterns) {
      if (pattern.keywords.some(keyword => name.includes(keyword))) {
        return { 
          type: pattern.type, 
          number: null,
          confidence: 'medium', 
          reason: pattern.reason
        };
      }
    }

    return { 
      type: null, 
      number: null,
      confidence: 'low', 
      reason: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå'
    };
  };

  // Analyze files when file list changes
  useEffect(() => {
    if (fileList.length > 0) {
      const analysis: FileTypeInfo[] = fileList.map(file => {
        const detection = detectDocumentType(file.name);
        return {
          fileName: file.name,
          detectedType: detection.type,
          detectedNumber: detection.number,
          confidence: detection.confidence,
          reason: detection.reason
        };
      });
      
      setFileTypeAnalysis(analysis);
    } else {
      setFileTypeAnalysis([]);
    }
  }, [fileList]);

  const uploadProps: UploadProps = {
    name: 'xmlFile',
    multiple: true,
    accept: '.xml',
    fileList,
    onChange: (info) => {
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á fileList ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á processing ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      if (!isProcessing && processedFiles.length === 0) {
        setFileList(info.fileList);
      }
    },
    onRemove: (file) => {
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á processing ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      if (isProcessing || processedFiles.length > 0) {
        message.warning('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ');
        return false;
      }
      
      const index = fileList.indexOf(file);
      const newFileList = fileList.slice();
      newFileList.splice(index, 1);
      setFileList(newFileList);
      
      // Remove from processed files too
      setProcessedFiles(prev => 
        prev.filter(pf => pf.file.uid !== file.uid)
      );
    },
    beforeUpload: (file) => {
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á processing ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      if (isProcessing || processedFiles.length > 0) {
        message.warning('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà"');
        return false;
      }

      // Validate file type
      const isXML = file.type === 'text/xml' || file.name.toLowerCase().endsWith('.xml');
      if (!isXML) {
        message.error(`${file.name} ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏ü‡∏•‡πå XML`);
        return false;
      }

      // Validate file size (5MB max)
      const isLt5M = file.size / 1024 / 1024 < 5;
      if (!isLt5M) {
        message.error(`${file.name} ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB`);
        return false;
      }

      return false; // Prevent auto upload
    },
    onDrop(e) {
      console.log('Dropped files', e.dataTransfer.files);
    },
  };

  const handleStartProcessing = async () => {
    if (fileList.length === 0) {
      message.warning('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå XML');
      return;
    }

    // Check if all files have detected types
    const filesWithoutDetection = fileTypeAnalysis.filter(
      analysis => !analysis.detectedType || analysis.confidence === 'low'
    );

    if (filesWithoutDetection.length > 0) {
      const proceed = await new Promise((resolve) => {
        Modal.confirm({
          title: '‚ö†Ô∏è ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏î‡πâ',
          content: (
            <div>
              <p>‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ:</p>
              <ul>
                {filesWithoutDetection.map(f => (
                  <li key={f.fileName}>
                    <strong>{f.fileName}</strong> - {f.reason}
                  </li>
                ))}
              </ul>
              <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</p>
            </div>
          ),
          okText: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠',
          cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          okType: 'danger',
          onOk: () => resolve(true),
          onCancel: () => resolve(false)
        });
      });

      if (!proceed) return;
    }

    setIsProcessing(true);
    setCurrentUploadIndex(0);
    
    // Initialize processed files with type detection info
    const initialProcessed: ProcessedFile[] = fileList.map((file, index) => {
      const analysis = fileTypeAnalysis[index];
      return {
        file,
        status: 'waiting',
        progress: 0,
        detectedType: analysis?.detectedType || undefined,
        detectedNumber: analysis?.detectedNumber || undefined,
        typeMatch: true // Always true now since we use detected type
      };
    });
    setProcessedFiles(initialProcessed);

    // Process files one by one
    for (let i = 0; i < fileList.length; i++) {
      setCurrentUploadIndex(i);
      await uploadSingleFile(fileList[i], i);
      
      // Small delay between uploads for better UX
      if (i < fileList.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    }

    setIsProcessing(false);
    setCurrentUploadIndex(-1);
    
    const successCount = processedFiles.filter(pf => pf.status === 'success').length;
    const failCount = processedFiles.filter(pf => pf.status === 'error').length;
    
    message.success(`‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡πÑ‡∏ü‡∏•‡πå, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failCount} ‡πÑ‡∏ü‡∏•‡πå`);
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å callback ‡πÄ‡∏û‡∏∑‡πà‡∏≠ refresh ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    if (successCount > 0 && onUploadSuccess) {
      setTimeout(() => {
        onUploadSuccess();
        message.info('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
      }, 1000);
    }

    // Reset component state ‡∏´‡∏•‡∏±‡∏á upload ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    setTimeout(() => {
      console.log('üîÑ Resetting upload component...');
      setFileList([]);
      setProcessedFiles([]);
      setFileTypeAnalysis([]);
      setCurrentUploadIndex(-1);
      setIsProcessing(false);
      
      // Reset file input ‡∏î‡πâ‡∏ß‡∏¢ (force re-render)
      const fileInputs = document.querySelectorAll('input[type="file"]');
      fileInputs.forEach((input: any) => {
        input.value = '';
      });
      
      message.success('üîÑ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!');
    }, 2000); // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á upload ‡πÄ‡∏™‡∏£‡πá‡∏à
  };

  const uploadSingleFile = async (file: UploadFile, index: number): Promise<void> => {
    // Update status to uploading
    setProcessedFiles(prev => prev.map((pf, i) => 
      i === index ? { ...pf, status: 'uploading', progress: 0 } : pf
    ));

    let controller: AbortController | null = null;

    try {
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      const formData = new FormData();
      formData.append('xmlFile', file.originFileObj as File);
      
      // Use detected type instead of selected type
      const analysis = fileTypeAnalysis[index];
      const documentType = analysis?.detectedType || 'SO'; // fallback to SO if no detection
      
      formData.append('docType', documentType);

      // Add detected document number if available
      if (analysis?.detectedNumber) {
        formData.append('docNumber', analysis.detectedNumber);
      }

      // Create abort controller for cleanup
      controller = new AbortController();

      const response = await axios.post<UploadResponse>(
        'http://localhost:3004/api/documents/upload',
        formData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'multipart/form-data',
          },
          signal: controller.signal,
          timeout: 30000, // 30 second timeout
          onUploadProgress: (progressEvent) => {
            const percentCompleted = Math.round(
              (progressEvent.loaded * 100) / (progressEvent.total || 1)
            );
            
            setProcessedFiles(prev => prev.map((pf, i) => 
              i === index ? { ...pf, progress: percentCompleted } : pf
            ));
          },
        }
      );

      if (response.data.success) {
        setProcessedFiles(prev => prev.map((pf, i) => 
          i === index ? { 
            ...pf, 
            status: 'success', 
            progress: 100,
            result: response.data 
          } : pf
        ));
        
        message.success(`${file.name} ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
      } else {
        throw new Error(response.data.message);
      }
    } catch (error: any) {
      console.error('Upload error:', error);
      
      setProcessedFiles(prev => prev.map((pf, i) => 
        i === index ? { 
          ...pf, 
          status: 'error', 
          progress: 0,
          result: { 
            success: false, 
            message: error.response?.data?.message || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' 
          }
        } : pf
      ));
      
      const errorMessage = error.response?.data?.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
      message.error(`${file.name}: ${errorMessage}`);
    } finally {
      // Cleanup - ‡∏õ‡∏¥‡∏î controller ‡πÅ‡∏•‡∏∞ clear references
      if (controller) {
        controller.abort();
      }
      
      // Force garbage collection ‡∏Ç‡∏≠‡∏á file references
      if (file.originFileObj) {
        try {
          // Clear file reference
          (file as any).originFileObj = null;
        } catch (e) {
          // Silent fail
        }
      }
      
      // Small delay to allow cleanup
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  };

  const clearAll = () => {
    setFileList([]);
    setProcessedFiles([]);
    setCurrentUploadIndex(-1);
    setIsProcessing(false);
    setFileTypeAnalysis([]);
    
    // Reset file input elements
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach((input: any) => {
      input.value = '';
    });
    
    message.success('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà!');
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reset ‡∏´‡∏•‡∏±‡∏á upload ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  const resetForNewUpload = () => {
    console.log('üîÑ Manual reset triggered...');
    setFileList([]);
    setProcessedFiles([]);
    setFileTypeAnalysis([]);
    setCurrentUploadIndex(-1);
    setIsProcessing(false);
    
    // Reset file input elements
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach((input: any) => {
      input.value = '';
    });
    
    message.success('üÜï ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!');
  };

  const getDocTypeColor = (type: string) => {
    switch (type) {
      case 'SO': return '#1890ff';
      case 'EN': return '#52c41a';
      case 'SH': return '#fa8c16';
      default: return '#d9d9d9';
    }
  };

  const getDocTypeLabel = (type: string) => {
    switch (type) {
      case 'SO': return '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢';
      case 'EN': return '‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
      case 'SH': return '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤';
      default: return type;
    }
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  return (
    <div>
      {/* Header */}
      <Row style={{ marginBottom: 24 }}>
        <Col span={24}>
          <Title level={2} style={{ marginBottom: 8 }}>
            üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ XML
          </Title>
        </Col>
      </Row>

      {/* Upload Configuration - Simplified */}
      {fileList.length > 0 && !isProcessing && processedFiles.length === 0 && (
        <Card 
          style={{ marginBottom: 24 }}
          size="small"
        >
          <Row gutter={[16, 16]} align="middle">
            <Col xs={24}>
              <Space>
                <Button
                  type="primary"
                  icon={<ArrowRightOutlined />}
                  onClick={handleStartProcessing}
                  loading={isProcessing}
                  disabled={fileList.length === 0}
                  size="large"
                >
                  {isProcessing ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...' : `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${fileList.length} ‡πÑ‡∏ü‡∏•‡πå`}
                </Button>
                <Button
                  icon={<DeleteOutlined />}
                  onClick={clearAll}
                  disabled={isProcessing}
                >
                  ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </Button>
              </Space>
            </Col>
          </Row>
        </Card>
      )}

      {/* Upload Area */}
      <Card
        title={
          <div style={{ display: 'flex', alignItems: 'center' }}>
            <InboxOutlined style={{ marginRight: 8, color: '#1890ff' }} />
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå XML
          </div>
        }
        style={{ marginBottom: 24 }}
      >
        <Dragger 
          {...uploadProps} 
          style={{ 
            padding: '40px 20px',
            opacity: (isProcessing || processedFiles.length > 0) ? 0.5 : 1
          }} 
          disabled={isProcessing || processedFiles.length > 0}
        >
          <p className="ant-upload-drag-icon">
            <InboxOutlined style={{ 
              fontSize: 48, 
              color: (isProcessing || processedFiles.length > 0) ? '#d9d9d9' : '#1890ff' 
            }} />
          </p>
          <p className="ant-upload-text" style={{ fontSize: 16 }}>
            {(isProcessing || processedFiles.length > 0) ? 
              '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß...' : 
              '‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå XML ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'
            }
          </p>
          <p className="ant-upload-hint" style={{ color: '#999' }}>
            {(isProcessing || processedFiles.length > 0) ? 
              '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà' :
              '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (SO, EN, SH) ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Ä¢ ‡πÑ‡∏ü‡∏•‡πå XML ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB'
            }
          </p>
        </Dragger>

        {/* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Reset ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà */}
        {(processedFiles.length > 0 || isProcessing) && (
          <div style={{ textAlign: 'center', marginTop: 16 }}>
            <Button 
              type="dashed" 
              onClick={resetForNewUpload}
              disabled={isProcessing}
              icon={<ArrowRightOutlined />}
            >
              üÜï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
            </Button>
          </div>
        )}
      </Card>

      {/* File Analysis Table */}
      {fileTypeAnalysis.length > 0 && !isProcessing && (
        <Card
          title="üîç ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå"
          style={{ marginBottom: 24 }}
          size="small"
        >
          <Table
            dataSource={fileTypeAnalysis.map((analysis, index) => ({
              key: index,
              ...analysis
            }))}
            pagination={false}
            size="small"
            columns={[
              {
                title: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå',
                dataIndex: 'fileName',
                key: 'fileName',
                render: (fileName: string) => (
                  <Text strong>{fileName}</Text>
                )
              },
              {
                title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö',
                dataIndex: 'detectedType',
                key: 'detectedType',
                render: (type: string | null, record: any) => {
                  if (!type) {
                    return <Text type="secondary">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ</Text>;
                  }
                  return (
                    <Space direction="vertical" size={2}>
                      <Space>
                        <Tag color={getDocTypeColor(type)}>{getDocTypeLabel(type)}</Tag>
                        <Tag color={record.confidence === 'high' ? 'green' : 'orange'}>
                          {record.confidence === 'high' ? '‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á' : '‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'}
                        </Tag>
                      </Space>
                      {record.detectedNumber && (
                        <Text type="secondary" style={{ fontSize: '11px' }}>
                          ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: {record.detectedNumber}
                        </Text>
                      )}
                    </Space>
                  );
                }
              },
              {
                title: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•',
                dataIndex: 'reason',
                key: 'reason',
                render: (reason: string) => (
                  <Text type="secondary" style={{ fontSize: '12px' }}>{reason}</Text>
                )
              }
            ]}
          />
        </Card>
      )}

      {/* Processing Status */}
      {isProcessing && processedFiles.length > 0 && (
        <Card 
          title="üîÑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•"
          style={{ marginBottom: 24 }}
        >
          <Steps
            direction="vertical"
            size="small"
            current={currentUploadIndex}
          >
            {processedFiles.map((pf, index) => (
              <Step
                key={pf.file.uid}
                title={
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span>{pf.file.name}</span>
                    {pf.detectedType && (
                      <Tag 
                        style={{ fontSize: '11px' }}
                        color={getDocTypeColor(pf.detectedType)}
                      >
                        {pf.detectedType}
                      </Tag>
                    )}
                  </div>
                }
                description={
                  <div>
                    <Text type="secondary">
                      {formatFileSize(pf.file.size || 0)}
                      {pf.detectedType && ` ‚Ä¢ ${getDocTypeLabel(pf.detectedType)}`}
                    </Text>
                    {pf.detectedNumber && (
                      <Text type="secondary" style={{ display: 'block', fontSize: '11px' }}>
                        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: {pf.detectedNumber}
                      </Text>
                    )}
                    {pf.status === 'uploading' && (
                      <Progress 
                        percent={pf.progress} 
                        size="small" 
                        style={{ marginTop: 4 }}
                      />
                    )}
                    {pf.status === 'success' && pf.result && (
                      <Text type="success" style={{ display: 'block', fontSize: '12px' }}>
                        ‚úÖ {pf.result.message}
                      </Text>
                    )}
                    {pf.status === 'error' && pf.result && (
                      <Text type="danger" style={{ display: 'block', fontSize: '12px' }}>
                        ‚ùå {pf.result.message}
                      </Text>
                    )}
                  </div>
                }
                status={
                  pf.status === 'success' ? 'finish' :
                  pf.status === 'error' ? 'error' :
                  pf.status === 'uploading' ? 'process' : 'wait'
                }
                icon={
                  pf.status === 'waiting' ? <ClockCircleOutlined /> :
                  pf.status === 'uploading' ? <UploadOutlined /> :
                  pf.status === 'success' ? <CheckCircleOutlined /> :
                  <ExclamationCircleOutlined />
                }
              />
            ))}
          </Steps>
        </Card>
      )}

      {/* Results Summary */}
      {!isProcessing && processedFiles.length > 0 && (
        <Card title="üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•">
          <Row gutter={[16, 16]}>
            <Col xs={8}>
              <Card size="small">
                <div style={{ textAlign: 'center' }}>
                  <Text type="secondary">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</Text>
                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1890ff' }}>
                    {processedFiles.length}
                  </div>
                </div>
              </Card>
            </Col>
            <Col xs={8}>
              <Card size="small">
                <div style={{ textAlign: 'center' }}>
                  <Text type="secondary">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</Text>
                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#52c41a' }}>
                    {processedFiles.filter(pf => pf.status === 'success').length}
                  </div>
                </div>
              </Card>
            </Col>
            <Col xs={8}>
              <Card size="small">
                <div style={{ textAlign: 'center' }}>
                  <Text type="secondary">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</Text>
                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#f5222d' }}>
                    {processedFiles.filter(pf => pf.status === 'error').length}
                  </div>
                </div>
              </Card>
            </Col>
          </Row>

          {processedFiles.filter(pf => pf.status === 'success').length === processedFiles.length && (
            <Result
              status="success"
              title="‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!"
              subTitle={`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ${processedFiles.length} ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`}
              extra={[
                <Button type="primary" key="upload-new" onClick={resetForNewUpload} size="large">
                  üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                </Button>,
                <Button key="view-docs" onClick={() => onUploadSuccess && onUploadSuccess()}>
                  üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </Button>
              ]}
              style={{ marginTop: 24 }}
            />
          )}

          {/* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Reset ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà error */}
          {processedFiles.filter(pf => pf.status === 'error').length > 0 && (
            <div style={{ textAlign: 'center', marginTop: 16 }}>
              <Button type="default" onClick={resetForNewUpload} icon={<ArrowRightOutlined />}>
                üîÑ ‡∏•‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
              </Button>
            </div>
          )}
        </Card>
      )}
    </div>
  );
};

export default DocumentUpload;
